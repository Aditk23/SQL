
use learn8;

CREATE FUNCTION MYSUM (@X AS INT, @Y AS INT)
RETURNS INT
AS
BEGIN
		DECLARE @Z AS INT;

		SET @Z = @X + @Y;

		RETURN @Z;
END;

SELECT DBO.MYSUM(10,20);

DROP FUNCTION CAL ;
CREATE FUNCTION CAL (@A AS INT, @B AS INT, @C AS CHAR(1))
RETURNS INT 
AS
BEGIN
		DECLARE @R AS INT;

		IF @C =  '+'
			SET @R  = @A + @B;
		ELSE IF @C =  '-'
			SET @R  = @A - @B;
		ELSE IF @C =  '*'
			SET @R  = @A * @B;
		ELSE IF @C =  '/'
			SET @R  = @A / @B;
		ELSE IF @C =  '%'
			SET @R  = @A % @B;
		ELSE
			SET @R = 0;
	
	RETURN @R;
END;

SELECT DBO.CAL(25,4,'&');

SELECT * FROM EMP;

-- AJAY SHARMA E0001 - ASHARMA0001@OUTLOOK.COM

CREATE FUNCTION GEMAIL (@N AS VARCHAR(30), @I AS CHAR(5))
RETURNS VARCHAR(50)
AS
BEGIN
		DECLARE @L AS INT;
		DECLARE @S AS INT;
		DECLARE @ID As VARCHAR(50);
		DECLARE @LN As VARCHAR(20);

		SET @L = LEN(@N);
		SET @S = CHARINDEX(' ', @N);
		
		SET @LN=RIGHT (@N, @L-@S);
		
		SET @ID = UPPER( CONCAT(LEFT(@N,1), @LN, RIGHT (@I, 4), '@OUTLOOK.COM '));

		RETURN @ID;
END;

SELECT * FROM EMP;

SELECT EID, NAME, DBO.GEMAIL(NAME, EID) AS 'CORP EMAIL' FROM EMP;

SELECT DBO.GEMAIL ('RAVI SHARMA', 'E0015');


-- SCALAR FUNCTION / SINGLE VALUED FUNCTION

-- TABLE VALUED FUCTION

USE TEST;

DROP FUNCTION L8SHEMP;

CREATE FUNCTION L8SHEMP()
RETURNS TABLE
AS
		RETURN(SELECT * FROM EMP 
			WHERE CITY = 'DELHI');


CREATE FUNCTION L8SHEMP(@X AS VARCHAR(20))
RETURNS TABLE
AS
		RETURN(SELECT * FROM EMP 
			WHERE CITY = @X);




SELECT * FROM DBO.L8SHEMP();
SELECT * FROM DBO.L8SHEMP('NOIDA');

DROP FUNCTION L8EMPSAL;
CREATE FUNCTION L8EMPSAL(@X AS VARCHAR(20))
RETURNS TABLE
AS
	RETURN(	SELECT EMP.EID, NAME, CITY, DOJ, DEPT, DESI, SALARY AS 'BASIC', SALARY * .15 AS 'HRA', SALARY *.09 AS 'PF'
			FROM EMP
			INNER JOIN EMP_SAL
			ON EMP.EID= EMP_SAL.EID
			WHERE DEPT = @X);

SELECT * FROM DBO.L8EMPSAL('IT');


SELECT * FROM EMP;
SELECT * FROM EMP_SAL;

SELECT EMP.EID, NAME, CITY
FROM EMP
INNER JOIN EMP_SAL
ON EMP.EID=EMP_SAL.EID
WHERE DESI = 'MANAGER';


SELECT EID, NAME, CITY
FROM EMP
WHERE EID IN (1004,1007,1008,1010, 1013,1028,1067, 1040,1074,1088);


SELECT EID, NAME, CITY
FROM EMP
WHERE EID IN (SELECT EID FROM EMP_SAL WHERE DESI ='MANAGER');

SELECT EID, DEPT, DESI, SALARY 
FROM EMP_SAL
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'DELHI');

SELECT * FROM TRAINING;

SELECT EMP.EID, NAME, DEPT, DESI
FROM EMP
INNER JOIN EMP_SAL
ON EMP.EID=EMP_SAL.EID
WHERE DEPT='MIS';


-- INSERT SUB QUERY

INSERT INTO TRAINING  (EID, NAME, DEPT)
(SELECT EMP.EID, NAME, DEPT
FROM EMP
INNER JOIN EMP_SAL
ON EMP.EID=EMP_SAL.EID
WHERE DEPT='MIS');

SELECT * FROM TRAINING;

UPDATE TRAINING SET MODULE = 'SQL';

-- DELETE SUBQUERY

DELETE FROM TRAINING 
WHERE EID IN (SELECT EID FROM EMP_SAL WHERE DESI='MANAGER');

SELECT * FROM EMP_SAL
WHERE EID IN( SELECT EID FROM EMP WHERE CITY='DELHI');


-- UPDATE SUBQUERY

UPDATE EMP_SAL SET SALARY = SALARY + 10000
WHERE EID IN ( SELECT EID FROM EMP WHERE CITY = 'DELHI');


SELECT * FROM EMP_SAL
WHERE EID IN( SELECT EID FROM EMP WHERE CITY='DELHI');

SELECT EID, NAME, CITY FROM EMP
WHERE EID IN ( SELECT EID FROM EMP_SAL WHERE SALARY >= 200000 )
ORDER BY CITY;

SELECT EID, NAME, CITY FROM EMP
WHERE EID = ( SELECT EID FROM EMP_SAL WHERE SALARY >= 400000 );

SELECT EID, NAME, CITY FROM EMP
WHERE EID IN ( SELECT EID FROM EMP_SAL WHERE SALARY BETWEEN 200000 AND  300000 );

SELECT COUNT(*) AS 'TEAM SIZE', AVG(SALARY)As 'AVG SAL' FROM EMP_SAL;

SELECT COUNT(*) AS 'DEL TEAM SIZE', AVG(SALARY)As 'DEL AVG SAL' FROM EMP_SAL
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'DELHI');


SELECT COUNT(*) AS 'DEL TEAM SIZE > 1L', AVG(SALARY)As 'DEL AVG SAL' FROM EMP_SAL
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'DELHI' AND
				EID IN (SELECT EID FROM EMP_SAL WHERE SALARY >100000));

-- A=> B => C   -- A => C -- A => A

SELECT * FROM EMP_SAL
WHERE DEPT ='HR' AND  EXISTS (SELECT * FROM EMP_SAL WHERE SALARY > 300000 AND DEPT ='HR')
;

SELECT * FROM EMP;

CREATE PROCEDURE L8EMP
AS
BEGIN
		SELECT * FROM EMP 
		WHERE CITY='DELHI';
END;

EXECUTE L8EMP;

EXEC L8EMP;

L8EMP;

DROP PROCEDURE  L8EMP;

CREATE PROCEDURE L8EMP @X AS VARCHAR(20)
AS
BEGIN 
	
		SELECT * FROM EMP
		WHERE CITY = @X;	
END;

L8EMP 'ABS';

CREATE PROCEDURE L8SAL @X AS VARCHAR(20)
AS
BEGIN
		SELECT EMP.EID, NAME, CITY, DOJ, DEPT, DESI, SALARY AS 'BASIC', SALARY *.15 AS 'HRA'
		FROM EMP
		INNER JOIN EMP_SAL
		ON EMP.EID= EMP_SAL.EID
		WHERE DEPT = @X;
END;

L8SAL 'TEMP';

SELECT * FROM EMP;

INSERT INTO EMP
VALUES(1093,'AJAY MALIK', 'HNO NO 120, STREET 6','RAJENDER NAGAR', 'DEHRADUN','9800245670','AJAY@GMAIL.COM','06-MAY-1985','11-MAY-2020');


DELETE FROM EMP_SAL WHERE EID = 1093;
DELETE FROM EMP WHERE EID = 1093;

SELECT * FROM EMP;

DROP PROCEDURE L8INEMP;

CREATE PROCEDURE L8INEMP @I AS INT, @N AS VARCHAR(30), @A1 AS VARCHAR(30), @A2 AS VARCHAR(30), @C AS VARCHAR(30), @PH AS CHAR(15), @EM AS VARCHAR(50), @DB AS DATE, @DJ AS DATE
AS
BEGIN
		INSERT INTO EMP
		VALUES (@I, @N, @A1, @A2, @C, @PH, @EM, @DB, @DJ);

		SELECT * FROM EMP WHERE EID = @I;
END;

L8INEMP 1093,'AJAY MALIK', 'HNO NO 120, STREET 6','RAJENDER NAGAR', 'DEHRADUN','9800245670','AJAY@GMAIL.COM','06-MAY-1985','11-MAY-2020';

CREATE PROCEDURE L8INEMP @I AS INT, @N AS VARCHAR(30), @A1 AS VARCHAR(30), @A2 AS VARCHAR(30), @C AS VARCHAR(30), @PH AS CHAR(15), @EM AS VARCHAR(50), @DB AS DATE, @DJ AS DATE, @DPT AS VARCHAR(20), @DSI AS VARCHAR(30), @X AS INT
AS
BEGIN
		SET NOCOUNT ON;
		INSERT INTO EMP
		VALUES (@I, @N, @A1, @A2, @C, @PH, @EM, @DB, @DJ);

		INSERT INTO EMP_SAL
		VALUES (@I, @DPT, @DSI, @X);

		SELECT * FROM EMP WHERE EID = @I;

		SELECT * FROM EMP_SAL WHERE EID = @I;

		SELECT EMP.EID, NAME, CITY, DOJ, DEPT, DESI, SALARY AS 'BASIC', SALARY * .15 AS 'HRA', SALARY *.09 AS 'PF'
		FROM EMP
		INNER JOIN EMP_SAL
		ON EMP.EID=EMP_SAL.EID
		WHERE EMP.EID = @I;
END;

SELECT * FROM EMP_SAL;

L8INEMP 1093,'AJAY MALIK', 'HNO NO 120, STREET 6','RAJENDER NAGAR', 'DEHRADUN','9800245670','AJAY@GMAIL.COM','06-MAY-1985','11-MAY-2020', 'TEMP', 'ASSOCIATE', 35000;

CREATE PROCEDURE L8SHOW @X AS VARCHAR(20)
AS
BEGIN 
		EXEC('SELECT * FROM ' + @X);
END;

L8SHOW 'CJ1';

USE LEARN8;

CREATE TABLE TEST
(ID INT,
NAME VARCHAR(10));

INSERT INTO TEST VALUES (1,'A');
INSERT INTO TEST VALUES (2,'B');
INSERT INTO TEST VALUES (3,'C');
INSERT INTO TEST VALUES (4,'D');
INSERT INTO TEST VALUES (5,'E');
INSERT INTO TEST VALUES (6,'F');
INSERT INTO TEST VALUES (7,'G');
INSERT INTO TEST VALUES (8,'H');
INSERT INTO TEST VALUES (9,'I');
INSERT INTO TEST VALUES (10,'J');

SELECT * FROM TEST;


DELETE FROM TEST WHERE ID = 10;

ROLLBACK;


BEGIN TRANSACTION;

DELETE FROM TEST WHERE ID= 9;

DELETE FROM TEST WHERE ID= 8;


SELECT * FROM TEST;

ROLLBACK;


BEGIN TRANSACTION;

DELETE FROM TEST WHERE ID= 5;

SAVE TRANSACTION T1;  -- SAVE POINTS
DELETE FROM TEST WHERE ID= 6;
DELETE FROM TEST WHERE ID= 7;

SAVE TRANSACTION T2;
DELETE FROM TEST WHERE ID= 8;

SAVE TRANSACTION T3;
DELETE FROM TEST WHERE ID= 9;


SELECT * FROM TEST;

ROLLBACK transaction T1;


BEGIN TRANSACTION ;

DELETE FROM TEST WHERE ID= 9;
DELETE FROM TEST WHERE ID= 8;

COMMIT;

ROLLBACK;

DROP TABLE EMP2;
CREATE TABLE EMP2
(ID INT IDENTITY (100,10) PRIMARY KEY,  --(START, INCREMENT)
NAME  VARCHAR(20),
AGE INT);

INSERT INTO EMP2 (NAME,AGE)
VALUES ('AJAY', 25);

INSERT INTO EMP2 (NAME,AGE)
VALUES ('KAPIL', 29);

INSERT INTO EMP2 
VALUES ('ROHAN', 24);


INSERT INTO EMP2 
VALUES ('RAM', 29);


SELECT * FROM EMP2;

DELETE FROM EMP2 WHERE ID=4;

insert INTO EMP2
VALUES ('AJEET',27);	

CREATE PROCEDURE INEMP2 @N AS VARCHAR(20), @X AS INT
AS
BEGIN
		INSERT INTO EMP2
		VALUES (@N, @X);

		SELECT * FROM EMP2;
END;

INEMP2 'RAMESH' , 30;
INEMP2 'AJAY' , 29;
